---
attack_technique: T1036
display_name: Masquerading

atomic_tests:
- name: Masquerading as Windows LSASS process
  description: |
    Copies cmd.exe, renames it, and launches it to masquerade as an instance of lsass.exe.

  supported_platforms:
    - windows

  executor:
    name: command_prompt
    elevation_required: false
    command: |
      cmd.exe /c copy %SystemRoot%\System32\cmd.exe %temp%\lsass.exe
      cmd.exe /c %temp%\lsass.exe /C hostname
      del /Q /F %temp%\lsass.exe
    cleanup_command: |
      del /Q /F %temp%\lsass.exe

- name: Masquerading as Linux crond process.
  description: |
    Copies sh process, renames it as crond, and executes it to masquerade as the cron daemon.

  supported_platforms:
    - linux

  executor:
    name: sh
    elevation_required: false
    command: |
      cp /bin/sh /tmp/crond
      /tmp/crond

- name: Masquerading - cscript.exe running as notepad.exe
  description: |
    Copies cscript.exe, renames it, and launches it to masquerade as an instance of notepad.exe.

  supported_platforms:
    - windows

  executor:
    name: command_prompt
    elevation_required: false
    command: |
      copy %SystemRoot%\System32\cscript.exe %temp%\notepad.exe /Y
      cmd.exe /c %temp%\notepad.exe /B
      del /Q /F %temp%\notepad.exe
    cleanup_command: |
      del /Q /F %temp%\notepad.exe

- name: Masquerading - wscript.exe running as svchost.exe
  description: |
    Copies wscript.exe, renames it, and launches it to masquerade as an instance of svchost.exe.

  supported_platforms:
    - windows

  executor:
    name: command_prompt
    elevation_required: false
    command: |
      copy %SystemRoot%\System32\wscript.exe C:\test\svchost.exe /Y
      cmd.exe /c C:\test\svchost.exe /B
    cleanup_command: |
      del /Q /F C:\test\svchost.exe

- name: Masquerading - powershell.exe running as taskhostw.exe
  description: |
    Copies powershell.exe, renames it, and launches it to masquerade as an instance of taskhostw.exe.

  supported_platforms:
    - windows

  executor:
    name: command_prompt
    elevation_required: false
    command: |
      copy %windir%\System32\windowspowershell\v1.0\powershell.exe C:\test\taskhostw.exe /Y
      cmd.exe /K %APPDATA%\taskhostw.exe
    cleanup_command: |
      del /Q /F C:\test\taskhostw.exe

- name: Masquerading - non-windows exe running as windows exe
  description: |
    Copies an exe, renames it as a windows exe, and launches it to masquerade as a real windows exe

  supported_platforms:
    - windows

  input_arguments:
    inputfile:
      description: path of file to copy
      type: path
      default: $PathToAtomicsFolder\T1036\bin\t1036.exe
    outputfile:
      description: path of file to execute
      type: path
      default: ($env:TEMP + "\svchost.exe")

  executor:
    name: powershell
    elevation_required: false
    command: |
      copy #{inputfile} #{outputfile}
      $myT1036 = (Start-Process -PassThru -FilePath #{outputfile}).Id
      Stop-Process -ID $myT1036
    cleanup_command: |
      del #{outputfile}

- name: Masquerading - windows exe running as different windows exe
  description: |
    Copies a windows exe, renames it as another windows exe, and launches it to masquerade as second windows exe

  supported_platforms:
    - windows

  input_arguments:
    inputfile:
      description: path of file to copy
      type: path
      default: $env:ComSpec
    outputfile:
      description: path of file to execute
      type: path
      default: ($env:TEMP + "\svchost.exe")

  executor:
    name: powershell
    elevation_required: false
    command: |
      copy #{inputfile} #{outputfile}
      $myT1036 = (Start-Process -PassThru -FilePath #{outputfile}).Id
      Stop-Process -ID $myT1036
    cleanup_command: |
      del #{outputfile}

- name: Malicious process Masquerading as LSM.exe
  description: |
    Detect LSM running from an incorrect directory and an incorrect service account
    This works by copying cmd.exe to a file, naming it lsm.exe, then copying a file to the C:\ folder.
  supported_platforms:
    - windows

  executor:
    name: command_prompt
    elevation_required: false
    command: |
      copy C:\Windows\System32\cmd.exe C:\test\lsm.exe
      C:\test\lsm.exe /c echo T1036 > C:\test\T1036.txt
    cleanup_command: |
      del C:\T1036.txt
      del C:\lsm.exe
